---
title: "Pseudobulk sgRNA GEX effects CTR02"
author: "Eric Wang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(Seurat)
library(ggplot2)
library(ggrepel)
library(gridExtra)
library(grid)
library(pheatmap)
library(viridis)
library(scales)
library(DESeq2)
knitr::opts_chunk$set(echo = TRUE)

source("../functions/scRNA_seq_analysis_functions.R")
source("../functions/plotting_fxns.R")
theme_set(theme_Publication())
```

## [Data Import]{.underline}

```{r}
data <- readRDS("C:/Users/Eric/My Drive/Lab/datasets/EYW/CTR02_10x_240516/processing/CTR02_seurat_SCT_CRISPRumi9.rds")
```

Add some metadata columns

```{r}
data <- subset(data, subset = num_features == 1)
data$feature_gene <- gsub("\\..*","",data$feature_call)
# split hash ID into separate organ and CD62L status
hashSplit <- data@meta.data %>%
  dplyr::select(hash.ID) %>%
  separate(hash.ID,c("organ","CD62L_status"), sep = "-")
data$organ <- hashSplit$organ
data$CD62L_status <- hashSplit$CD62L_status
```

## [All Cells Pseudobulk]{.underline}

First, I will take a look at DEG analysis of pseudobulk analysis of all cells while adjusting for organ and CD62L status given their effects on transcriptional variability.

```{r, results='hide'}
# perform pseudobulk aggregation
pseudodata <- AggregateExpression(data, assays = "SCT", return.seurat = T, group.by = c("organ","CD62L_status","feature_call"))
pseudodata <- pseudodata[!grepl("^Tra[vdj]|^Trb[vdj]",rownames(pseudodata)),]

# gather info for metadata
# get UMIs per sgRNA
# get frequency of single sgRNA integrations for individual sgRNA
# get percent.mt
metaData <- data@meta.data %>%
  as_tibble(rownames = "cell_bc") %>%
  group_by(organ, CD62L_status, feature_gene, feature_call) %>%
  summarise(freq_cells = n()/nrow(data@meta.data),
            median_sgRNA_umi = median(as.numeric(num_umis)),
            mito_perc = mean(percent.mt))

# convert metadata to df form
ddsColData <- metaData  %>%
  mutate(feature_gene = gsub("NTC|NCC","control",feature_gene)) %>%
  as.data.frame()
rownames(ddsColData) <- paste(ddsColData$organ,ddsColData$CD62L_status,ddsColData$feature_call,sep="_")

# create DESeq2 object
dds <- DESeqDataSetFromMatrix(pseudodata@assays$SCT$counts,
                              colData = ddsColData,
                              design = ~ feature_gene + organ + CD62L_status)
dds <- DESeq(dds)

resLFCIfngr1 <- lfcShrink(dds, contrast = c("feature_gene","Ifngr1","control"), type = "ashr")
resLFCTgfbr2 <- lfcShrink(dds, contrast = c("feature_gene","Tgfbr2","control"), type = "ashr")

resLFCIfngr1Tidy <- resLFCIfngr1  %>%
  as_tibble(rownames = "genes") %>%
  arrange(padj)
resLFCTgfbr2Tidy <- resLFCTgfbr2  %>%
  as_tibble(rownames = "genes") %>%
  arrange(padj)

write_csv(resLFCIfngr1Tidy,"analysis_outs/pseudobulk_bulk_ifngr1_DEG.csv")
write_csv(resLFCTgfbr2Tidy,"analysis_outs/pseudobulk_bulk_tgfbr2_DEG.csv")
```

## [Ifngr1 KO comparison]{.underline}

Here, I will compare these results to the signature of Ifngr1 KO cells in https://www.nature.com/articles/s41590-023-01453-w, which used a flox mouse

```{r}
infectedDEG <- read_csv("external_datasets/gocher_infected_Ifngr1KO_Foxp3Cre_DEG.csv")
uninfectedDEG <- read_csv("external_datasets/gocher_uninfected_Ifngr1KO_Foxp3Cre_DEG.csv")
```

```{r, fig.height=12, fig.width=12}
infectedSigUp <- infectedDEG %>% filter(p_val_adj < 0.1 & avg_log2FC > 0)
infectedSigDown <- infectedDEG %>% filter(p_val_adj < 0.1 & avg_log2FC < 0)
uninfectedSigUp <- uninfectedDEG %>% filter(p_val_adj < 0.1 & avg_log2FC > 0)
uninfectedSigDown <- uninfectedDEG %>% filter(p_val_adj < 0.1 & avg_log2FC < 0)

ifngr1Comp <- resLFCIfngr1Tidy %>%
  mutate(infected_sig = case_when(genes %in% infectedSigUp$genes ~ "sig_up",
                                  genes %in% infectedSigDown$genes ~ "sig_down"),
         uninfected_sig = case_when(genes %in% uninfectedSigUp$genes ~ "sig_up",
                                  genes %in% uninfectedSigDown$genes ~ "sig_down")) %>%
  mutate(infected_sig = replace_na(infected_sig,"not_sig"),
         uninfected_sig = replace_na(uninfected_sig, "not_sig")) %>%
  mutate(infected_sig = factor(infected_sig, c("sig_up","sig_down","not_sig")),
         uninfected_sig = factor(uninfected_sig, c("sig_up","sig_down","not_sig"))) %>%
  filter(padj < 0.1)

Tgfbr2Comp <- resLFCTgfbr2Tidy %>%
  mutate(infected_sig = case_when(genes %in% infectedSigUp$genes ~ "sig_up",
                                  genes %in% infectedSigDown$genes ~ "sig_down"),
         uninfected_sig = case_when(genes %in% uninfectedSigUp$genes ~ "sig_up",
                                  genes %in% uninfectedSigDown$genes ~ "sig_down")) %>%
  mutate(infected_sig = replace_na(infected_sig,"not_sig"),
         uninfected_sig = replace_na(uninfected_sig, "not_sig")) %>%
  mutate(infected_sig = factor(infected_sig, c("sig_up","sig_down","not_sig")),
         uninfected_sig = factor(uninfected_sig, c("sig_up","sig_down","not_sig"))) %>%
  filter(padj < 0.1)

p1 <- ggplot(ifngr1Comp , aes(x = log2FoldChange, y = -log10(padj), color = infected_sig)) +
  geom_point() +
  scale_color_brewer(palette = "Dark2") +
  xlim(-2.3,2.3) +
  theme(aspect.ratio = 1) +
  ggtitle("Perturb Ifngr1 KO DEGs\n(pseudobulk)")

p2 <- ggplot(ifngr1Comp , aes(x = log2FoldChange, y = -log10(padj), color = uninfected_sig)) +
  geom_point() +
  scale_color_brewer(palette = "Dark2") +
  xlim(-2.3,2.3) +
  theme(aspect.ratio = 1) +
  ggtitle("Perturb Ifngr1 KO DEGs\n(pseudobulk)")

p3 <- ggplot(Tgfbr2Comp , aes(x = log2FoldChange, y = -log10(padj), color = infected_sig)) +
  geom_point() +
  scale_color_brewer(palette = "Dark2") +
  xlim(-2.3,2.3) +
  theme(aspect.ratio = 1) +
  ggtitle("Perturb Tgfbr2 KO DEGs\n(pseudobulk)")

p4 <- ggplot(Tgfbr2Comp , aes(x = log2FoldChange, y = -log10(padj), color = uninfected_sig)) +
  geom_point() +
  scale_color_brewer(palette = "Dark2") +
  xlim(-2.3,2.3) +
  theme(aspect.ratio = 1) +
  ggtitle("Perturb Tgfbr2 KO DEGs\n(pseudobulk)")

(p1+p2)/(p3+p4)
ggsave("analysis_outs/perturb_ifngr1flox_comp_volcano.pdf")
```

```{r, fig.height=10, fig.width=12}
p1 <- resLFCIfngr1Tidy %>%
  left_join(infectedDEG) %>%
  filter(padj < 0.1 | p_val_adj < 0.1) %>%
  drop_na() %>%
  mutate(sig_category = case_when(padj < 0.1 & p_val_adj < 0.1 ~ "both",
                                  padj >= 0.1 & p_val_adj < 0.1 ~ "infected_only",
                                  padj < 0.1 & p_val_adj >= 0.1 ~ "perturb_only",)) %>%
  mutate(sig_category = factor(sig_category, c("both","perturb_only","infected_only"))) %>%
  ggplot(aes(x = log2FoldChange, y = avg_log2FC, color = sig_category)) +
    geom_point()+
    scale_color_brewer(palette = "Dark2") +
    xlim(-4,4) +
    ylim(-4,4) +
    theme(aspect.ratio = 1) +
    ggtitle("Ifngr1 KO comparison")

p2 <- resLFCIfngr1Tidy %>%
  left_join(uninfectedDEG) %>%
  filter(padj < 0.1 | p_val_adj < 0.1) %>%
  drop_na() %>%
  mutate(sig_category = case_when(padj < 0.1 & p_val_adj < 0.1 ~ "both",
                                  padj >= 0.1 & p_val_adj < 0.1 ~ "uninfected_only",
                                  padj < 0.1 & p_val_adj >= 0.1 ~ "perturb_only",)) %>%
  mutate(sig_category = factor(sig_category, c("both","perturb_only","uninfected_only"))) %>%
  ggplot(aes(x = log2FoldChange, y = avg_log2FC, color = sig_category)) +
    geom_point()+
    scale_color_brewer(palette = "Dark2") +
    xlim(-4,4) +
    ylim(-4,4) +
    theme(aspect.ratio = 1) +
    ggtitle("Ifngr1 KO comparison")

p3 <- resLFCTgfbr2Tidy %>%
  left_join(infectedDEG) %>%
  filter(padj < 0.1 | p_val_adj < 0.1) %>%
  drop_na() %>%
  mutate(sig_category = case_when(padj < 0.1 & p_val_adj < 0.1 ~ "both",
                                  padj >= 0.1 & p_val_adj < 0.1 ~ "infected_only",
                                  padj < 0.1 & p_val_adj >= 0.1 ~ "perturb_only",)) %>%
  mutate(sig_category = factor(sig_category, c("both","perturb_only","infected_only"))) %>%
  ggplot(aes(x = log2FoldChange, y = avg_log2FC, color = sig_category)) +
    geom_point()+
    scale_color_brewer(palette = "Dark2") +
    xlim(-4,4) +
    ylim(-4,4) +
    theme(aspect.ratio = 1) +
    ggtitle("Tgfbr2 KO comparison")

p4 <- resLFCTgfbr2Tidy %>%
  left_join(infectedDEG) %>%
  filter(padj < 0.1 | p_val_adj < 0.1) %>%
  drop_na() %>%
  mutate(sig_category = case_when(padj < 0.1 & p_val_adj < 0.1 ~ "both",
                                  padj >= 0.1 & p_val_adj < 0.1 ~ "uninfected_only",
                                  padj < 0.1 & p_val_adj >= 0.1 ~ "perturb_only",)) %>%
  mutate(sig_category = factor(sig_category, c("both","perturb_only","uninfected_only"))) %>%
  ggplot(aes(x = log2FoldChange, y = avg_log2FC, color = sig_category)) +
    geom_point()+
    scale_color_brewer(palette = "Dark2") +
    xlim(-4,4) +
    ylim(-4,4) +
    theme(aspect.ratio = 1) +
    ggtitle("Tgfbr2 KO comparison")

(p1+p2)/(p3+p4)
```


### Group Specific Pseudobulk

Here, I will compare the DEG analysis of bulk sgRNA vs those separated by
resting/activated and tissue

```{r, results="hide"}
# perform pseudobulk aggregation
pseudodata1 <- AggregateExpression(data, assays = "SCT", return.seurat = T, group.by = c("organ","feature_gene","feature_call"))
pseudodata1 <- pseudodata1[!grepl("^Tra[vdj]|^Trb[vdj]",rownames(pseudodata1)),]
pseudodata1$feature_gene <- gsub("NTC|NCC","control",pseudodata1$feature_gene) %>%
  factor(c("control","Ifngr1","Tgfbr2"))

# perform pseudobulk aggregation
pseudodata2 <- AggregateExpression(data, assays = "SCT", return.seurat = T, group.by = c("CD62L_status","feature_gene","feature_call"))
pseudodata2 <- pseudodata2[!grepl("^Tra[vdj]|^Trb[vdj]",rownames(pseudodata2)),]
pseudodata2$feature_gene <- gsub("NTC|NCC","control",pseudodata2$feature_gene) %>%
  factor(c("control","Ifngr1","Tgfbr2"))

pdOrgan <- vector(mode = "list")
pdOrgan[["spleen"]] <- subset(pseudodata1, subset = organ == "spleen")
pdOrgan[["mLN"]] <- subset(pseudodata1, subset = organ == "mLN")
pdOrgan[["CD62Lpos"]] <- subset(pseudodata2, subset = CD62L_status == "CD62Lpos")
pdOrgan[["CD62Lneg"]] <- subset(pseudodata2, subset = CD62L_status == "CD62Lneg")

# find variable features for each subset
pdOrgan <- lapply(pdOrgan, function(x) FindVariableFeatures(x, nfeature = 2000))

# create DESeq2 object
ddsOrgan <- lapply(pdOrgan, function(x) DESeqDataSetFromMatrix(x@assays$SCT$counts,
                                                               colData = x@meta.data,
                                                               design = ~ feature_gene))

# run DEseq analysis
ddsOrgan <- lapply(ddsOrgan, function(x) DESeq(x))

# add dds with pooled cells from above
ddsOrgan[["all"]] <- dds
```

First, we'll look at Ifngr1 KO DEGs

```{r, fig.height=10, fig.width=12}
# calculate DEGs for all conditions
ifngr1DEG <- function(x){
  resLFC <- lfcShrink(x, contrast = c("feature_gene","Ifngr1","control"), type = "ashr")
  resLFC <- resLFC %>%
    as_tibble(rownames = "genes")
}

# create list of tibbles with DEG results
resIfngr1 <- lapply(ddsOrgan, function(x) ifngr1DEG(x))

# Combine the tibbles into a single data frame with an identifier
combinedTib <- bind_rows(
  lapply(seq_along(resIfngr1), function(i) {
    resIfngr1[[i]] %>%
      mutate(tibble_id = names(resIfngr1)[i])
  })
)

# Separate the first tibble for comparison
referenceTib <- combinedTib %>% filter(tibble_id == "all")
comparisonTib <- combinedTib %>% filter(tibble_id != "all")

# Merge the reference tibble with the comparison data
comparisonTib1 <- comparisonTib %>%
  left_join(referenceTib, by = "genes", suffix = c("", "_ref")) %>%
  mutate(
    significance = case_when(
      padj_ref < 0.1 & padj < 0.1 ~ "both",
      padj_ref < 0.1 ~ "pooled cells specific",
      padj < 0.1 ~ "group specific",
      TRUE ~ "none"
    )) %>%
  mutate(significance = factor(significance, c("none","pooled cells specific","group specific","both"))
  )

# Plotting
ggplot(comparisonTib1, aes(x = log2FoldChange_ref, y = log2FoldChange, color = significance)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  facet_wrap(~tibble_id) +
  theme(aspect.ratio = 1) +
  scale_color_brewer(palette = "Dark2") +
  xlim(-3,3) +
  ylim(-3,3) +
  labs(
    title = "Comparison of shrunken Log2FC for Ifngr1 KO",
    x = "log2FC (pooled cells)",
    y = "log2FC (group)"
  )
```

```{r fig.height=6,fig.width=12}
# Separate the first tibble for comparison
referenceTib <- combinedTib %>% filter(tibble_id == "spleen")
comparisonTib <- combinedTib %>% filter(tibble_id == "mLN")

# Merge the reference tibble with the comparison data
comparisonTib1 <- comparisonTib %>%
  left_join(referenceTib, by = "genes", suffix = c("", "_ref")) %>%
  mutate(
    significance = case_when(
      padj_ref < 0.1 & padj < 0.1 ~ "both",
      padj_ref < 0.1 ~ "spleen",
      padj < 0.1 ~ "mLN",
      TRUE ~ "none"
    )) %>%
  mutate(significance = factor(significance, c("none","spleen","mLN","both"))
  )
write_csv(comparisonTib1,"analysis_outs/pseudobulk_ifngr1_spleen_mLN_DEG.csv")

# Plotting
p1 <- ggplot(comparisonTib1, aes(x = log2FoldChange_ref, y = log2FoldChange, color = significance)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  scale_color_brewer(palette = "Dark2") +
  theme(aspect.ratio = 1) +
  xlim(-4,4) +
  ylim(-4,4) +
  labs(
    title = "Ifngr1 KO spleen vs mLN",
    x = "log2FC spleen",
    y = "log2FC mLN"
  )

# Separate the first tibble for comparison
referenceTib <- combinedTib %>% filter(tibble_id == "CD62Lpos")
comparisonTib <- combinedTib %>% filter(tibble_id == "CD62Lneg")

# Merge the reference tibble with the comparison data
comparisonTib1 <- comparisonTib %>%
  left_join(referenceTib, by = "genes", suffix = c("", "_ref")) %>%
  mutate(
    significance = case_when(
      padj_ref < 0.1 & padj < 0.1 ~ "both",
      padj_ref < 0.1 ~ "CD62Lpos",
      padj < 0.1 ~ "CD62Lneg",
      TRUE ~ "none"
    )) %>%
  mutate(significance = factor(significance, c("none","CD62Lneg","CD62Lpos","both"))
  )
write_csv(comparisonTib1,"analysis_outs/pseudobulk_ifngr1_CD62Lpos_neg_DEG.csv")

# Plotting
p2 <- ggplot(comparisonTib1, aes(x = log2FoldChange_ref, y = log2FoldChange, color = significance)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  theme(aspect.ratio = 1) +
  scale_color_brewer(palette = "Dark2") +
  xlim(-4,4) +
  ylim(-4,4) +
  labs(
    title = "Ifngr1 KO CD62L+ vs CD62L-",
    x = "log2FC CD62L+",
    y = "log2FC CD62L-"
  )

grid.arrange(p1,p2, ncol=2)
```

```{r, fig.height=10, fig.width=12}
# calculate DEGs for all conditions
tgfbr2DEG <- function(x){
  resLFC <- lfcShrink(x, contrast = c("feature_gene","Tgfbr2","control"), type = "ashr")
  resLFC <- resLFC %>%
    as_tibble(rownames = "genes")
}

# create list of tibbles with DEG results
resTgfbr2 <- lapply(ddsOrgan, function(x) tgfbr2DEG(x))

# Combine the tibbles into a single data frame with an identifier
combinedTib <- bind_rows(
  lapply(seq_along(resTgfbr2), function(i) {
    resTgfbr2[[i]] %>%
      mutate(tibble_id = names(resTgfbr2)[i])
  })
)

# Separate the first tibble for comparison
referenceTib <- combinedTib %>% filter(tibble_id == "all")
comparisonTib <- combinedTib %>% filter(tibble_id != "all")

# Merge the reference tibble with the comparison data
comparisonTib2 <- comparisonTib %>%
  left_join(referenceTib, by = "genes", suffix = c("", "_ref")) %>%
  mutate(
    significance = case_when(
      padj_ref < 0.1 & padj < 0.1 ~ "both",
      padj_ref < 0.1 ~ "pooled cells specific",
      padj < 0.1 ~ "group specific",
      TRUE ~ "none"
    )) %>%
  mutate(significance = factor(significance, c("none","pooled cells specific","group specific","both"))
  )

# Plotting
ggplot(comparisonTib2, aes(x = log2FoldChange_ref, y = log2FoldChange, color = significance)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  facet_wrap(~tibble_id) +
  theme(aspect.ratio = 1) +
  scale_color_brewer(palette = "Dark2") +
  xlim(-3,3) +
  ylim(-3,3) +
  labs(
    title = "Comparison of shrunken Log2FC for Ifngr1 KO",
    x = "log2FC (pooled cells)",
    y = "log2FC (group)"
  )
```

```{r fig.height=7,fig.width=12}
# Separate the first tibble for comparison
referenceTib <- combinedTib %>% filter(tibble_id == "spleen")
comparisonTib <- combinedTib %>% filter(tibble_id == "mLN")

# Merge the reference tibble with the comparison data
comparisonTib1 <- comparisonTib %>%
  left_join(referenceTib, by = "genes", suffix = c("", "_ref")) %>%
  mutate(
    significance = case_when(
      padj_ref < 0.1 & padj < 0.1 ~ "both",
      padj_ref < 0.1 ~ "spleen",
      padj < 0.1 ~ "mLN",
      TRUE ~ "none")) %>%
  mutate(significance = factor(significance, c("none","spleen","mLN","both"))) 
write_csv(comparisonTib1,"analysis_outs/pseudobulk_tgfbr2_spleen_mLN_DEG.csv")

# Plotting
p1 <- ggplot(comparisonTib1, aes(x = log2FoldChange_ref, y = log2FoldChange, color = significance)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  scale_color_brewer(palette = "Dark2") +
  theme(aspect.ratio = 1) +
  xlim(-3,3) +
  ylim(-3,3) +
  labs(
    title = "Ifngr1 KO spleen vs mLN",
    x = "log2FC spleen",
    y = "log2FC mLN"
  )

# Separate the first tibble for comparison
referenceTib <- combinedTib %>% filter(tibble_id == "CD62Lpos")
comparisonTib <- combinedTib %>% filter(tibble_id == "CD62Lneg")

# Merge the reference tibble with the comparison data
comparisonTib1 <- comparisonTib %>%
  left_join(referenceTib, by = "genes", suffix = c("", "_ref")) %>%
  mutate(
    significance = case_when(
      padj_ref < 0.1 & padj < 0.1 ~ "both",
      padj_ref < 0.1 ~ "CD62Lpos",
      padj < 0.1 ~ "CD62Lneg",
      TRUE ~ "none"
    )) %>%
  mutate(significance = factor(significance, c("none","CD62Lneg","CD62Lpos","both"))
  )
write_csv(comparisonTib1,"analysis_outs/pseudobulk_ifngr1_CD62Lpos_neg_DEG.csv")

# Plotting
p2 <- ggplot(comparisonTib1, aes(x = log2FoldChange_ref, y = log2FoldChange, color = significance)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  theme(aspect.ratio = 1) +
  scale_color_brewer(palette = "Dark2") +
  xlim(-3,3) +
  ylim(-3,3) +
  labs(
    title = "Ifngr1 KO CD62L+ vs CD62L-",
    x = "log2FC CD62L+",
    y = "log2FC CD62L-"
  )

grid.arrange(p1,p2, ncol=2)
```